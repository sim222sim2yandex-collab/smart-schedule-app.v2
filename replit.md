# Умное расписание врачей - Smart Doctor Scheduling System

Веб-приложение на Python для оптимизации расписания врачей с использованием генетического алгоритма, прогнозирования спроса и анализа данных.

## Технологии

- **Python 3.11** - основной язык
- **Streamlit** - веб-интерфейс
- **DEAP** - генетический алгоритм
- **Prophet** - прогнозирование временных рядов
- **Pandas** - обработка данных
- **PostgreSQL** - база данных
- **SQLAlchemy** - ORM
- **Plotly** - интерактивная визуализация

## Структура базы данных

### Таблицы

#### 1. `doctors` - Справочник врачей
- `doctor_id` (PRIMARY KEY) - ID врача
- `doctor_fio` - ФИО врача
- `branch_id` - ID филиала
- `role_specialty` - Роль/Специальность
- `required_cab_specs` - Требуемые специализации кабинета
- `available_nomenclature_ids` - Доступная номенклатура услуг
- `is_star` - Признак "звезда" (фиксированное расписание)
- `start_date` - Дата начала работы
- `is_dms` - Работа с ДМС
- `is_mobile` - Выездной врач
- `issues_sick_leave` - Выписка больничных листов
- `schedule_rule` - Правило графика работы
- `standard_slot_time` - Стандартное время слота (мин)
- `vacation_dates` - Даты отпусков
- `hard_binding_cab_id` - Жесткая привязка к кабинету
- `soft_binding_cab_ids` - Мягкая привязка к кабинетам

#### 2. `cabinets` - Справочник кабинетов
- `cabinet_id` (PRIMARY KEY) - ID кабинета
- `branch_id` - ID филиала
- `cabinet_number` - Номер кабинета
- `cabinet_specs` - Специализации кабинета
- `schedule_rule` - Правило графика работы кабинета

#### 3. `appointments` - История записей
- `appointment_id` (PRIMARY KEY) - ID записи
- `appointment_date` - Дата и время приема
- `doctor_id` (FOREIGN KEY) - ID врача
- `cabinet_id` (FOREIGN KEY) - ID кабинета
- `slot_time` - Время слота
- `nomenclature_id` - ID услуги
- `service_price` - Стоимость услуги
- `source_channel` - Источник (канал записи)
- `sick_leave_issued` - Был выписан БЛ

#### 4. `doctor_revenue` - Доходы врачей
- `id` (PRIMARY KEY) - Автоинкремент ID
- `doctor_id` (FOREIGN KEY) - ID врача
- `month` - Месяц
- `total_direct_income` - Сумма прямого дохода
- `total_referral_income` - Сумма косвенного дохода

#### 5. `seasonal_coefficients` - Сезонные коэффициенты
- `season_id` (PRIMARY KEY) - ID сезонности
- `month_number` - Номер месяца (1-12)
- `specialty` - Специальность
- `seasonal_factor` - Сезонный коэффициент
- `comment` - Комментарий

#### 6. `promo_calendar` - Календарь маркетинговых акций
- `promo_id` (PRIMARY KEY) - ID акции
- `start_date` - Дата начала
- `end_date` - Дата окончания
- `specialty` - Специальность
- `promo_factor` - Акционный коэффициент
- `promo_name` - Название акции

## Фазы работы алгоритма

### Фаза 1: Подготовка данных и прогнозирование
1. Загрузка данных из Excel или из базы данных
2. Валидация и очистка данных
3. Прогнозирование спроса на услуги с использованием Prophet
4. Расчет финансовых показателей и коэффициентов заполняемости врачей
5. Применение корректирующих коэффициентов (сезонность, акции, буфер)

### Фаза 2: Генерация расписаний
1. Генерация популяции валидных расписаний (хромосом)
2. Соблюдение жестких ограничений:
   - Графики работы врачей и кабинетов
   - Смены (утро/вечер/день/ночь)
   - Соответствие специализаций
   - Фиксированные графики "звезд"
   - Привязки к кабинетам

### Фаза 3: Генетическая оптимизация
1. Оценка каждого расписания через функцию приспособленности
2. Критерии оценки:
   - **Спрос** (30%) - покрытие прогнозируемого спроса
   - **Выручка** (25%) - прогнозируемая выручка
   - **Надежность** (20%) - коэффициент надежности врачей
   - **Стратегия** (15%) - ДМС, выезд, БЛ
   - **Персонал** (10%) - баланс нагрузки, новые врачи
3. Генетические операторы:
   - Селекция (турнирная)
   - Кроссовер (по дням)
   - Мутация (swap врачей, кабинетов, смена времени)
4. Эволюция через несколько поколений до достижения оптимума

## Модули приложения

- `app.py` - Главное приложение Streamlit
- `database_manager.py` - Работа с PostgreSQL базой данных
- `data_processor.py` - Обработка и валидация данных
- `forecasting.py` - Прогнозирование спроса (Prophet)
- `schedule_generator.py` - Генерация валидных расписаний
- `fitness_evaluator.py` - Функция приспособленности
- `genetic_algorithm.py` - Генетический алгоритм (DEAP)
- `visualization.py` - Визуализация результатов
- `utils.py` - Экспорт в Excel/CSV
- `load_data_to_db.py` - Скрипт загрузки данных из Excel в БД

## Запуск приложения

```bash
streamlit run app.py --server.port 5000
```

## Загрузка данных в БД

```bash
python3 load_data_to_db.py
```

## Экспорт результатов

Приложение поддерживает экспорт:
- Оптимального расписания (Excel/CSV)
- Аналитических отчетов
- Показателей врачей
- Прогнозов спроса
- Метрик качества

## Переменные окружения

- `DATABASE_URL` - URL подключения к PostgreSQL
- `PGHOST`, `PGPORT`, `PGUSER`, `PGPASSWORD`, `PGDATABASE` - параметры БД

## Архитектура решения

1. **Данные** → PostgreSQL/SQLlite (6 таблиц со справочниками и историей) 
2. **Прогнозирование** → Prophet (тренды, сезонность, праздники)
3. **Генерация** → Случайные валидные расписания с жесткими ограничениями
4. **Оптимизация** → DEAP генетический алгоритм (популяция → эволюция → лучшее решение)
5. **Визуализация** → Plotly графики и таблицы
6. **Экспорт** → Excel/CSV файлы

## Текущий статус БД

```
Врачи: 4
Кабинеты: 6
Записи: 5
Доходы: 3 записи
Сезонные коэффициенты: 3
Маркетинговые акции: 1

Диапазон дат записей: 2024-11-01 до 2024-11-02
```
